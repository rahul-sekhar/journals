'use strict';

angular.module('journals', 
  ['journals.user', 'journals.people', 'journals.editInPlace', 'journals.filters', 'journals.pagination', 
  'journals.onType', 'journals.modals', 'journals.filteredList']).
  
  config(['$locationProvider', '$httpProvider', function($locationProvider, $httpProvider) {
    $locationProvider.html5Mode(true);

    $httpProvider.defaults.headers.common['X-CSRF-Token'] = $('meta[name=csrf-token]').attr('content');
    $httpProvider.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
  }]).

  run(['User', '$rootScope', function(User, $rootScope) {
    $rootScope.user = User;
    $rootScope.$watch('user.type', function(value) {
      $rootScope.isTeacher = (value == 'Teacher');
    });
  }]).
  
  config(['$routeProvider', function($routeProvider) {
    
    var peopleRouteParams = function(pageData) {
      return {
        templateUrl: '<%= asset_path("people.html") %>', 
        controller: 'PeopleCtrl', 
        reloadOnSearch: false,
        pageData: (pageData || {})
      }
    };

    $routeProvider.

      when('/login', {redirectTo: '/'}).

      when('/', {redirectTo: '/people'}).

      when('/people', peopleRouteParams({
        filter: 'Students and teachers',
        canAddTeacher: true,
        canAddStudent: true
      })).

      when('/people/archived', peopleRouteParams({
        filter: 'Archived students and teachers'
      })).

      when('/teachers', peopleRouteParams({
        filter: 'Teachers',
        canAddTeacher: true
      })).

      when('/teachers/:id', peopleRouteParams()).

      when('/students', peopleRouteParams({
        filter: 'Students',
        canAddStudent: true
      })).

      when('/students/:id', peopleRouteParams()).

      when('/guardians/:id', peopleRouteParams()).

      when('/guardians', {redirectTo: '/page-not-found'}).

      when('/mentees', peopleRouteParams({
        filter: 'Your mentees'
      })).

      when('/groups/:id', peopleRouteParams({
        isGroup: true
      })).

      when('/page-not-found', {templateUrl: '<%= asset_path("404.html") %>'}).

      otherwise({redirectTo: '/page-not-found'});
  }]);